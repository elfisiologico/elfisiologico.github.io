<!DOCTYPE html>
<html lang="es" __gchrome_remoteframetoken="ebf9a209eb864718389487a6034d481b"><head><style>
        @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
        html {
          font-family: 'Google Sans Text', 'Google Sans';
          font-size: 14px;
          color-scheme: light dark;
          background: light-dark(white, black);
          color: light-dark(black, white);
        }
        </style>
        
        
        <script>
          window.APPLET_FILES = ["index.tsx","metadata.json","index.html"];
          </script>
        <script type="module">
        (() => {
  if (window.self === window.top) {
    // Do not run the shim in the main window, only in iframes.
    return;
  }

  window.API_KEY = 'GEMINI_API_KEY';
  window.GEMINI_API_KEY = 'GEMINI_API_KEY';
  window.process = window.process || {};
  window.process.env = window.process.env || {};
  window.process.env.API_KEY = window.API_KEY;
  window.process.env.GEMINI_API_KEY = window.GEMINI_API_KEY;

  const bootstrapChannel = new Promise((resolve) => {
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://aistudio.google.com') {
        return;
      }

      if (event.data.type === 'bootstrap') {
        resolve({
          port: event.ports[0],
          urlPatterns:
              event.data.urlPatterns.map((pattern) => new RegExp(pattern)),
        });
      }
    });
  });

  window.aistudio = window.aistudio || {
    handleFullscreenEsc: true,
    getHostUrl: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_host_url'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.url);
        };
      });
    },
    hasSelectedApiKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'has_selected_api_key'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data);
        };
      });
    },
    openSelectKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'open_select_key'},
          [channel.port2]);
    },
    getModelQuota: async function(model) {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_model_quota', model},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.modelQuota);
        };
      });
    },
  };

  const nativeFetch = window.fetch;

  /**
   * @param {string | URL | Request} resource The resource of the fetch request.
   * @param {RequestInit} options The options of the fetch request.
   * @return {Promise!} The promise of the fetch request.
   */
  async function fetch(resource, options) {
    const config = await bootstrapChannel;

    const request = resource instanceof Request ?
      resource.clone() :
      new Request(resource, options);

    if (!config.urlPatterns.some((pattern) => request.url.match(pattern))) {
      return nativeFetch(resource, options);
    }
    const hostPort = config.port;

    const channel = new MessageChannel();
    const port = channel.port1;
    let bodyBytes;
    const transfer = [channel.port2];
    const parts = [];
    const buffer = await request.arrayBuffer();
    if (buffer.byteLength) {
      bodyBytes = buffer;
      transfer.push(bodyBytes);
    }
    hostPort.postMessage(
        {
          type: 'fetch',
          url: request.url,
          method: request.method,
          headers: [...request.headers.entries()],
          body: bodyBytes,
        },
        transfer);

    let streamController;
    const body = new ReadableStream({
      start(controller) {
        streamController = controller;
      },
    });
    let resolveReceive;
    const receivePromise = new Promise((resolve) => {
      resolveReceive = resolve;
    });
    port.onmessage = (message) => {
      switch (message.data.type) {
        case 'response':
          resolveReceive(new Response(body, {
            status: message.data.status,
            statusText: message.data.statusText,
            headers: new Headers(message.data.headers),
          }));
          break;
        case 'body':
          streamController.enqueue(message.data.data);
          break;
        case 'body_done':
          streamController.close();
          break;
      }
    };
    return receivePromise;
  }

  Object.defineProperty(window, 'fetch', {
    get: function() {
      return fetch;
    },
  });

  // See details in: https://github.com/angular/angular/issues/63064.
  function patchHistoryStateFunctionForAngular(originalFn, baseHref) {
    return (state, unused, url) => {
      if (typeof url === 'string' && !url.startsWith('blob:')) {
        url = baseHref + url;
      }
      return originalFn.apply(window.history, [state, unused, url]);
    };
  }

  if (false) {
    const baseHref = window.location.href;
    window.history.replaceState = patchHistoryStateFunctionForAngular(window.history.replaceState, baseHref);
    window.history.pushState = patchHistoryStateFunctionForAngular(window.history.pushState, baseHref);
  }

  const originalWebSocket = window.WebSocket;
  class ProxiedWebSocket extends EventTarget {
    /**
     * @param {string} url The url of the websocket.
     * @param {Object!} protocols The protocols of the websocket.
     */
    constructor(url, protocols) {
      super();
      this.url = url;
      this.protocols = protocols;

      this.open();
    }

    /** Opens the websocket. */
    async open() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'websocket_open', url: this.url, protocols: this.protocols},
          [channel.port2]);
      this.port = channel.port1;
      this.port.onmessage = (message) => {
        if (message.data.type === 'close') {
          const event = new CloseEvent('close', {
            code: message.data.code,
            reason: message.data.reason,
            wasClean: message.data.wasClean,
          });
          if (this.onclose) {
            this.onclose(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'open') {
          const event = new Event('open');
          if (this.onopen) {
            this.onopen(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'message') {
          let data = message.data.data;
          if (message.data.messageType === 'text' || message.data.messageType === 'message') {
            data = new TextDecoder().decode(data);
          }
          const event = new MessageEvent('message', {
            data,
            type: message.data.messageType,
          });
          if (this.onmessage) {
            this.onmessage(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'error') {
          const event = new ErrorEvent('error', {
            message: message.data.message,
          });
          if (this.onerror) {
            this.onerror(event);
          }
          this.dispatchEvent(event);
          return;
        }
        console.error('received unknown message in frame', event.data);
      };
    }
    /**
     * @param {string|ArrayBuffer!} data The data to send.
     */
    send(data) {
      if (typeof data === 'string') {
        this.port.postMessage({type: 'send', data});
      } else {
        this.port.postMessage({type: 'send', data}, [data.buffer]);
      }
    }

    /**
     * @param {number} code The code of the close event.
     * @param {string} reason The reason of the close event.
     */
    close(code, reason) {
      this.port.postMessage({type: 'close', code, reason});
    }
  }

  /**
   * @param {string} url The url of the websocket.
   * @param {Object!} protocols The protocols of the websocket.
   * @return {WebSocket!} The websocket.
   */
  function createWebSocket(url, protocols) {
    // This should come from the bootstrap channel, but we want this to
    // work for the synchronous constructor here.
    if (url.startsWith('wss://generativelanguage.googleapis.com/')) {
      return Reflect.construct(ProxiedWebSocket, [url, protocols]);
    }
    return Reflect.construct(originalWebSocket, [url, protocols]);
  }

  Object.defineProperty(window, 'WebSocket', {
    get: function() {
      return createWebSocket;
    },
  });

  async function instrumentErrorReporting() {
    const errors = [];
    let hostPort;

    function reportError(message) {
      if (!hostPort) {
        errors.push(message);
      } else {
        hostPort.postMessage({type: 'error', message: message}, message);
      }
    }

    function serialize(args) {
      return args.map((a) => {
        if (a instanceof Error || a instanceof ErrorEvent) {
          return a.message;
        }
        if(a instanceof CloseEvent) {
          return {code: a.code, reason: a.reason, wasClean: a.wasClean};
        }
        if( a instanceof Map) {
          return JSON.parse(JSON.stringify([...a.entries()]));
        }
        if( a instanceof Set) {
          return JSON.parse(JSON.stringify([...a.values()]));
        }
        if (a instanceof Object) {
          return JSON.parse(JSON.stringify(a));
        }
        return a;
      });
    }

    const originalConsole = window.console;
    const originalConsoleLog = window.console.log;
    const originalConsoleError = window.console.error;
    const originalConsoleWarn = window.console.warn;
    const originalConsoleDebug = window.console.debug;
    window.console = {
      ...originalConsole,
      log: (message, ...args) => {
        originalConsoleLog.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_log', message: combined });
      },
      debug: (message, ...args) => {
        originalConsoleDebug.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_debug', message: combined });
      },
      error: (message, ...args) => {
        originalConsoleError.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_error', message: combined });
      },
      warn: (message, ...args) => {
        originalConsoleWarn.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_warn', message: combined });
      },
    };

    window.onerror = (message, source, lineno, colno, error) => {
      reportError({type: 'error', message: serialize([message]), source, lineno, colno, error});
    };

    window.onunhandledrejection = (event) => {
      reportError({type: 'unhandledrejection', message: serialize([event.reason])});
    };

    window.alert = (message) => {
      reportError({type: 'alert', message: serialize([message]) });
    };

    hostPort = (await bootstrapChannel).port;
    for(const error of errors) {
      hostPort.postMessage({type: 'error', message: error});
    }
  }

  const availableFiles = new Set(window.APPLET_FILES || []);

  instrumentErrorReporting();

  if (false) {
    const notifyLocationChange = async () => {
      const hostPort = (await bootstrapChannel).port;
      hostPort.postMessage({type: 'locationchange', href: location.href});
    };

    // Send initial state on load.
    notifyLocationChange();

    const originalPushState = history.pushState;
    history.pushState = (...args) => {
      originalPushState.apply(history, args);
      notifyLocationChange();
    };

    const originalReplaceState = history.replaceState;
    history.replaceState = (...args) => {
      originalReplaceState.apply(history, args);
      notifyLocationChange();
    };
    window.addEventListener('popstate', (e) => {
      notifyLocationChange();
    });
  }

  window.addEventListener('hashchange', async (e) =>{
    const config = await bootstrapChannel;
    const hostPort = config.port;
    hostPort.postMessage({type: 'hashchange', hash: window.location.hash});
    if (false) {
      hostPort.postMessage({
        type: 'locationchange',
        href: location.href,
      });
    }
  });

  if (true) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas-pro';
    script.onload = () => {
      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'capture-screenshot') {
          try {
            const canvas = await html2canvas(document.documentElement, {
              logging: false,
              useCORS: true,
              backgroundColor: null,
              scale: 1,
            });
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-result',
                dataUrl: canvas.toDataURL('image/png'),
                requestId: event.data.requestId,
                scrollX: document.body.scrollLeft,
                scrollY: document.body.scrollTop,
              },
            );
          } catch (e) {
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-error',
                error: e.message,
                requestId: event.data.requestId,
              });
          }
        }
      });
    };
    document.head.appendChild(script);
  }

  if (false) {
    const MAX_ANCESTOR_LEVEL = 3;
    const MAX_DESCENDANT_LEVEL = 3;

    function getElementSelector(el) {
      if (!el || el.nodeType !== 1) {
        return '';
      }
      const parts = [];
      while(el && el.nodeType === 1 && el.tagName.toLowerCase() !== 'body') {
        let part = el.tagName.toLowerCase();
        if (el.id) {
          part += '#' + CSS.escape(el.id);
        }

        const parent = el.parentElement;
        if (parent) {
          let nth = 1;
          let prev = el.previousElementSibling;
          while(prev) {
            if (prev.tagName === el.tagName) {
              nth++;
            }
            prev = prev.previousElementSibling;
          }
          part += ':nth-of-type(' + nth + ')';
        }

        parts.unshift(part);
        el = el.parentElement;
      }
      return parts.join(' > ');
    }

    function getDomTreeAsString(element, depth, maxDepth) {
      if (!element || element.nodeType !== 1 || depth > maxDepth) {
        return '';
      }
      const tagName = element.tagName.toLowerCase();
      let attrs = [];
      if (element.id) {
        attrs.push('id="' + element.id + '"');
      }
      if (element.classList.length > 0) {
        attrs.push('class="' + element.classList.value + '"');
      }
      const attrString = attrs.length > 0 ? ' ' + attrs.join(' ') : '';

      let content = '';
      for (const node of element.childNodes) {
        if (node.nodeType === 1) { // Element node
          content += getDomTreeAsString(node, depth + 1, maxDepth);
        } else if (node.nodeType === 3) { // Text node
          content += node.textContent;
        }
      }

      return '<' + tagName + attrString + '>' + content + '</' + tagName + '>';
    }

    const style = document.createElement('style');
    style.textContent =
      '.aistudio-focus-mode-highlight { box-shadow: inset 0 0 0 0.5px white, inset 0 0 0 1.5px #87a9ff !important; }' +
      '#aistudio-focus-mode-tag { position: absolute; display: none; background: #87a9ff; border-radius: 4px; border: 0.5px solid white; z-index: 10000; text-transform: lowercase; padding: 2px 4px; color: #32302c; font-family: Inter, sans-serif; font-size: 12px; font-style: normal; font-weight: 400; line-height: 16px; pointer-events: none; }';
    document.head.appendChild(style);

    let highlightedElement = null;
    let focusTag = null;
    let resizeObserver = null;
    let iframeLoaded = false;

    function positionFocusTag() {
      if (!highlightedElement || !focusTag) return;
      requestAnimationFrame(() => {
        focusTag.style.display = 'inline-flex';
        const rect = highlightedElement.getBoundingClientRect();
        focusTag.style.top =
          rect.top + window.scrollY - focusTag.offsetHeight - 5 + 'px';
        focusTag.style.left = rect.left + window.scrollX + 'px';
      });
    }

    if (window.ResizeObserver) {
      resizeObserver = new ResizeObserver(() => {
        positionFocusTag();
      });
    }

    function highlight(element) {
      if (!iframeLoaded) return; // Do not highlight if iframe is not loaded
      if (!focusTag) {
        focusTag = document.createElement('div');
        focusTag.id = 'aistudio-focus-mode-tag';
        document.body.appendChild(focusTag);
      }

      const hadHighlightedElement = !!highlightedElement;
      if (highlightedElement) {
        highlightedElement.classList.remove('aistudio-focus-mode-highlight');
        highlightedElement.removeAttribute('data-aistudio-tag-name');
        if (resizeObserver) {
          resizeObserver.unobserve(highlightedElement);
        }
      }
      focusTag.style.display = 'none';
      highlightedElement = element;
      const hasHighlightedElement = !!highlightedElement;

      if (!hadHighlightedElement && hasHighlightedElement) {
        window.addEventListener('resize', positionFocusTag);
        window.addEventListener('scroll', positionFocusTag, true);
      } else if (hadHighlightedElement && !hasHighlightedElement) {
        window.removeEventListener('resize', positionFocusTag);
        window.removeEventListener('scroll', positionFocusTag, true);
      }

      if (highlightedElement) {
        highlightedElement.setAttribute(
          'data-aistudio-tag-name',
          highlightedElement.tagName,
        );
        highlightedElement.classList.add('aistudio-focus-mode-highlight');
        focusTag.textContent = highlightedElement.tagName.toLowerCase();
        positionFocusTag();
        if (resizeObserver) {
          resizeObserver.observe(highlightedElement);
        }
      }
    }

    window.addEventListener('load', () => {
      iframeLoaded = true;
    });

    window.addEventListener('message', async (event) => {
      if (event.data?.type === 'highlight-element-at-point') {
        try {
          const element = document.elementFromPoint(
            event.data.x,
            event.data.y,
          );
          highlight(element);
        } catch (e) {
          highlight(null);
        }
      } else if (event.data?.type === 'highlight-element-by-selector') {
        try {
          const selector = event.data.selector;
          if (selector) {
            const element = document.querySelector(selector);
            highlight(element);
          } else {
            highlight(null);
          }
        } catch (e) {
          highlight(null);
        }
      } else if (event.data?.type === 'get-element-at-point') {
        try {
          const element = document.elementFromPoint(
            event.data.x,
            event.data.y,
          );
          const hostPort = (await bootstrapChannel).port;
          if (!element) {
            hostPort.postMessage({
              type: 'element-at-point-error',
              error: 'No element found at point',
              requestId: event.data.requestId,
            });
            return;
          }
          const selector = getElementSelector(element);

          let levelsUp = 0;
          let root = element;
          while(levelsUp < MAX_ANCESTOR_LEVEL && root.parentElement && root.parentElement.tagName.toLowerCase() !== 'html') {
            root = root.parentElement;
            levelsUp++;
          }
          const domString = getDomTreeAsString(root, 0, levelsUp + MAX_DESCENDANT_LEVEL);

          const styles = window.getComputedStyle(element);
          const css = {};
          for (let i = 0; i < styles.length; i++) {
            const key = styles[i];
            css[key] = styles.getPropertyValue(key);
          }
          hostPort.postMessage({
            type: 'element-at-point-result',
            element: {
              selector: selector,
              domString: domString,
              css: css,
              x: event.data.x,
              y: event.data.y,
            },
            requestId: event.data.requestId,
          });
        } catch (e) {
          const hostPort = (await bootstrapChannel).port;
          hostPort.postMessage({
            type: 'element-at-point-error',
            error: e.message,
            requestId: event.data.requestId,
          });
        }
      } else if (event.data?.type === 'change-element-style') {
        try {
          const selector = event.data.selector;
          if (selector) {
            const element = document.querySelector(selector);
            if (element) {
              element.style.setProperty(
                event.data.property,
                event.data.value,
                'important',
              );
              positionFocusTag();
            }
          }
        } catch (e) {}
      }
    });
  }

  window.addEventListener('keydown', async (event) => {
    if (event.key === 'Escape' && window.aistudio?.handleFullscreenEsc) {
      const hostPort = (await bootstrapChannel).port;
      hostPort.postMessage({type: 'exit-fullscreen'});
    }
  });
})();
// # sourceURL=iframe_shim.js
        </script>
        <base href="https://ai.studio">



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Científico – El_FisioLógico</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&amp;family=JetBrains+Mono:wght@400;700&amp;display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #0F0F0F;
            --border-color: #272727;
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1A1;
            --accent: #FCBF06;
            --accent-hover: #D4A005;
            --danger: #FF4B4B;
            --success: #00E676;
            
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Utilities */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-4 { gap: 1rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
        .text-accent { color: var(--accent); }
        .font-mono { font-family: var(--font-mono); }
        .uppercase { text-transform: uppercase; }
        .text-sm { font-size: 0.875rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .p-4 { padding: 1rem; }
        .border { border: 1px solid var(--border-color); }
        .rounded { border-radius: 6px; }

        /* Typography */
        h1, h2, h3 { font-weight: 800; letter-spacing: -0.02em; margin-top: 0; }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; margin-bottom: 1.5rem; }
        h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 0.5rem; }

        /* UI Components */
        .btn {
            background: var(--accent);
            color: var(--bg-color);
            border: none;
            padding: 12px 24px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            font-family: var(--font-mono);
            transition: all 0.2s;
            border-radius: 4px;
        }
        .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn:disabled { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; }
        
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
        
        .btn-black { background: #000000; border: 1px solid #333; color: #FFFFFF; }
        .btn-black:hover { border-color: #fff; }

        textarea, input, select {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 4px;
            font-family: var(--font-main);
            width: 100%;
        }
        textarea:focus, input:focus { border-color: var(--accent); }

        /* Header */
        header {
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            margin-bottom: 40px;
            position: sticky;
            top: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .brand { font-family: var(--font-mono); font-weight: 700; font-size: 1.2rem; }
        .brand span { color: var(--accent); }

        /* Input Section */
        #input-section textarea {
            min-height: 300px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Form/Wizard */
        .wizard-step { background: var(--surface-color); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 2rem; }
        .field-group { margin-bottom: 1rem; }
        .field-group label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        
        .score-slider-container { display: flex; align-items: center; gap: 10px; }
        .score-val { font-family: var(--font-mono); font-weight: bold; color: var(--accent); width: 30px; }

        /* Dashboard Styles */
        .dashboard-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .meta-table { width: 100%; border-collapse: collapse; }
        .meta-table td { padding: 8px 0; border-bottom: 1px solid var(--border-color); vertical-align: top; }
        .meta-table td:first-child { width: 140px; color: var(--text-secondary); font-size: 0.9rem; }
        .meta-table tr:last-child td { border-bottom: none; }

        .analysis-text { font-size: 1.05rem; text-align: justify; }
        .highlight { color: var(--accent); font-weight: 600; }
        
        /* Justification Table */
        .rubric-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        .rubric-table th { text-align: left; color: var(--accent); border-bottom: 1px solid var(--accent); padding: 8px; }
        .rubric-table td { padding: 8px; border-bottom: 1px solid var(--border-color); }
        .score-badge { display: inline-block; padding: 2px 8px; background: var(--border-color); border-radius: 4px; font-family: var(--font-mono); font-size: 0.8rem; }

        /* Quiz */
        .quiz-item { margin-bottom: 1.5rem; border-left: 2px solid var(--border-color); padding-left: 1rem; }
        .quiz-options { display: grid; gap: 0.5rem; margin-top: 0.5rem; }
        .quiz-btn { text-align: left; padding: 8px 12px; background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; border-radius: 4px; transition: all 0.2s; }
        .quiz-btn:hover { border-color: var(--text-primary); }
        .quiz-btn.correct { border-color: var(--success); color: var(--success); background: rgba(0, 230, 118, 0.1); }
        .quiz-btn.wrong { border-color: var(--danger); color: var(--danger); }
        .explanation { font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-secondary); font-style: italic; display: none; }

        /* Print/Export overrides */
        @media print {
            body { background: #fff; color: #000; }
            .no-print { display: none; }
            .dashboard-card { box-shadow: none; border: 1px solid #ddd; }
        }

        /* Applicability List */
        .app-list { list-style: none; padding: 0; }
        .app-list li { margin-bottom: 0.8rem; padding-left: 1.2rem; position: relative; }
        .app-list li::before { content: "•"; color: var(--accent); position: absolute; left: 0; font-weight: bold; }
    </style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas-pro"></script></head>
<body style="cursor: default;">

    <!-- Header -->
    

    <div id="app-container" class="container">
        
        <!-- STEP 1: INPUT -->
        

        <!-- STEP 2: CONFIRMATION (WIZARD) -->
        

        <!-- STEP 3: FINAL DASHBOARD -->
        <article id="dashboard-view" class="">
            
            <!-- Hero Info -->
            <div class="dashboard-card" style="border-left: 4px solid var(--accent);">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-accent font-mono text-sm uppercase tracking-wider" id="dash-design">Ensayo clínico aleatorizado, paralelo, simple ciego</span>
                        <h1 class="mt-2 mb-2" id="dash-title">Effect of blood flow restriction training with core stabilization exercise on muscle activity and muscle thickness in subjects with nonspecific chronic low back pain</h1>
                        <p class="text-secondary font-mono text-sm"><span id="dash-authors">Phurichaya Werasirirat, Juntip Namsawang, Nutsupa Singhasoot, Nongnuch Luangpon, Audrius Snieckus, Pornpimol Muanjai</span> • <span id="dash-year">2026</span> • <span id="dash-journal">Journal of Back and Musculoskeletal Rehabilitation</span></p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-secondary uppercase">El_FisioLógico</div>
                        <div class="font-bold text-xl mt-1 text-accent">SCORE: <span id="dash-total-score">21</span>/30</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                
                <!-- Left Col: Justification Table -->
                <div>
                    <div class="dashboard-card">
                        <h2>Justificación Metodológica</h2>
                        <table class="rubric-table">
                            <thead>
                                <tr>
                                    <th>Dimensión</th>
                                    <th>Score</th>
                                    <th>Evidencia</th>
                                </tr>
                            </thead>
                            <tbody id="rubric-body"><tr>
                    <td class="font-bold">Diseño</td>
                    <td><span class="score-badge">4/5</span></td>
                    <td class="text-secondary">Ensayo clínico aleatorizado, diseño paralelo, protocolo registrado y cegamiento simple (participantes).</td>
                </tr><tr>
                    <td class="font-bold">Muestra</td>
                    <td><span class="score-badge">3/5</span></td>
                    <td class="text-secondary">Tamaño muestral calculado por potencia (n=38), pero la población es joven y muy homogénea, limitando la validez externa.</td>
                </tr><tr>
                    <td class="font-bold">Control de Sesgos</td>
                    <td><span class="score-badge">3/5</span></td>
                    <td class="text-secondary">Aleatorización por bloques adecuada, pero ausencia de grupo placebo y falta de doble ciego (terapeutas no cegados).</td>
                </tr><tr>
                    <td class="font-bold">Variables</td>
                    <td><span class="score-badge">4/5</span></td>
                    <td class="text-secondary">Uso de herramientas válidas y fiables: EMG normalizada, ecografía en modo B y cuestionario MODQ validado.</td>
                </tr><tr>
                    <td class="font-bold">Transferencia Clínica</td>
                    <td><span class="score-badge">3/5</span></td>
                    <td class="text-secondary">Intervención de 4 semanas clínicamente aplicable y segura, pero la falta de seguimiento a medio plazo limita la certeza sobre la duración del efecto.</td>
                </tr><tr>
                    <td class="font-bold">Coherencia</td>
                    <td><span class="score-badge">4/5</span></td>
                    <td class="text-secondary">Los hallazgos sobre activación muscular y BFR son consistentes con la literatura previa en rehabilitación y fisiología.</td>
                </tr></tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Col: Narrative & Tables -->
                <div>
                    <div class="dashboard-card">
                        <h2>Ficha Técnica</h2>
                        <table class="meta-table">
                            <tbody><tr>
                                <td>Población</td>
                                <td id="dash-pop" class="font-mono">Adultos jóvenes (18–45 años) con dolor lumbar crónico inespecífico</td>
                            </tr>
                            <tr>
                                <td>Intervención</td>
                                <td id="dash-int" class="font-mono text-accent">Ejercicio de estabilización del core combinado con entrenamiento con restricción de flujo sanguíneo (BFR+CSE)</td>
                            </tr>
                            <tr>
                                <td>Resultados Clave</td>
                                <td>
                                    <ul id="dash-results-list" class="app-list text-sm"><li>El grupo BFR+CSE mostró mejoras significativas intra-grupo en la actividad EMG normalizada de transverso del abdomen, multífidos y glúteo mayor.</li><li>Se observó un aumento significativo del grosor muscular tanto en reposo como en contracción en el grupo BFR+CSE.</li><li>El grupo BFR+CSE experimentó una reducción significativa de la discapacidad medida con el MODQ.</li><li>El grupo de solo ejercicio (CSE) presentó mejoras limitadas, restringidas principalmente a la EMG del multífido y grosor en reposo.</li><li>Las comparaciones entre grupos favorecieron consistentemente al grupo BFR+CSE frente al CSE aislado en todas las variables evaluadas.</li></ul>
                                </td>
                            </tr>
                        </tbody></table>
                    </div>

                    <div class="dashboard-card">
                        <h2>Análisis Crítico</h2>
                        <div id="dash-critical-text" class="analysis-text">El diseño del estudio, un ensayo clínico aleatorizado simple ciego, es adecuado para evaluar efectos de intervención, aunque el cegamiento se limita a los participantes, no a los terapeutas. El cálculo muestral está justificado y el tamaño final (n=38) cumple con la potencia estadística prevista, si bien sigue siendo modesto y vulnerable a variabilidad interindividual. La muestra se caracteriza por adultos jóvenes con bajo índice de masa corporal y discapacidad moderada, lo que define un perfil clínico concreto y relativamente homogéneo. Esto mejora la validez interna pero reduce la transferencia a poblaciones con mayor edad, comorbilidades o dolor lumbar más complejo. El control de sesgos es aceptable en cuanto a aleatorización y estandarización de la intervención, aunque la ausencia de grupo placebo o control sin manguito limita la atribución específica de los efectos al BFR. Las variables seleccionadas son pertinentes desde el punto de vista fisioterapéutico: EMG normalizada, grosor muscular ecográfico y discapacidad funcional. Las técnicas de medición están bien descritas y presentan buena fiabilidad intraexaminador. No obstante, la interpretación de aumentos en EMG como fuerza debe hacerse con cautela, ya que se trata de una medida indirecta de activación neuromuscular. La transferencia clínica es moderada: el protocolo es relativamente corto, de baja carga y potencialmente aplicable en contextos de rehabilitación donde la carga mecánica está limitada. Sin embargo, la falta de seguimiento impide conocer la persistencia de los efectos. La coherencia con la literatura es adecuada y los autores discuten los hallazgos en línea con estudios previos sobre BFR y adaptaciones neuromusculares. <div class="mt-4 p-4 border rounded bg-opacity-10 bg-yellow-500 font-bold text-accent border-l-4">El estudio aporta evidencia moderada para la aplicación de BFR combinado con ejercicio de estabilización del core en dolor lumbar crónico inespecífico, con implicaciones clínicas relevantes.</div></div>
                    </div>

                     <div class="dashboard-card">
                        <h2>Aplicabilidad Clínica</h2>
                        <div class="analysis-text">
                            <p class="mb-4">Análisis de transferencia a la práctica clínica invasiva y conservadora:</p>
                            <ul id="dash-clinical-list" class="app-list"><li><span class="text-white font-bold">Electrólisis Percutánea:</span> <span class="text-secondary">El estudio no evalúa intervenciones de electrólisis percutánea ni estimulación eléctrica invasiva, por lo que no se pueden inferir efectos combinados.</span></li><li><span class="text-white font-bold">Neuromodulación:</span> <span class="text-secondary">Los cambios observados en la EMG sugieren una posible modulación central de la activación muscular, aunque el estudio no evalúa parámetros neurofisiológicos directos ni técnicas como tDCS.</span></li><li><span class="text-white font-bold">Punción Seca:</span> <span class="text-secondary">No se aborda en el estudio; cualquier integración con punción seca sería especulativa al no existir datos en el texto.</span></li><li><span class="text-white font-bold">Ejercicio / BFR:</span> <span class="text-secondary">El BFR aplicado distalmente combinado con ejercicio de estabilización del core (CSE) potencia la activación y grosor muscular proximal y reduce la discapacidad más que el CSE aislado. Es una opción útil para inducir adaptaciones neuromusculares cuando la carga mecánica está limitada.</span></li></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="dashboard-card">
                <h2>Quiz Formativo</h2>
                <div id="quiz-container"><div class="quiz-item">
                    <p class="font-bold mb-2">1. ¿Cuál fue el hallazgo principal al comparar el grupo BFR+CSE con el grupo de solo CSE?</p>
                    <div class="quiz-options">
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'El estudio reporta que la comparación intergrupos favoreció consistentemente al grupo BFR+CSE en todas las variables (EMG, grosor y discapacidad).')">El BFR no mostró diferencias respecto al ejercicio solo.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, true, 'El estudio reporta que la comparación intergrupos favoreció consistentemente al grupo BFR+CSE en todas las variables (EMG, grosor y discapacidad).')">El BFR+CSE mejoró más la activación muscular y redujo la discapacidad que el CSE solo.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'El estudio reporta que la comparación intergrupos favoreció consistentemente al grupo BFR+CSE en todas las variables (EMG, grosor y discapacidad).')">El CSE solo fue superior para la hipertrofia del glúteo mayor.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'El estudio reporta que la comparación intergrupos favoreció consistentemente al grupo BFR+CSE en todas las variables (EMG, grosor y discapacidad).')">Ambos grupos empeoraron su discapacidad funcional.</button>
                        
                    </div>
                    <div class="explanation"></div>
                </div><div class="quiz-item">
                    <p class="font-bold mb-2">2. ¿Qué variables objetivas se utilizaron para medir los cambios estructurales y neuromusculares?</p>
                    <div class="quiz-options">
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'La metodología especifica el uso de ecografía modo B para el grosor muscular y electromiografía (EMG) para la actividad muscular.')">Fuerza máxima isométrica directa.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'La metodología especifica el uso de ecografía modo B para el grosor muscular y electromiografía (EMG) para la actividad muscular.')">Resonancia magnética funcional.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, true, 'La metodología especifica el uso de ecografía modo B para el grosor muscular y electromiografía (EMG) para la actividad muscular.')">Grosor muscular mediante ecografía y actividad EMG.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'La metodología especifica el uso de ecografía modo B para el grosor muscular y electromiografía (EMG) para la actividad muscular.')">Niveles de lactato en sangre.</button>
                        
                    </div>
                    <div class="explanation"></div>
                </div><div class="quiz-item">
                    <p class="font-bold mb-2">3. ¿Cuál es la población específica estudiada en este ensayo clínico?</p>
                    <div class="quiz-options">
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'Los metadatos indican claramente que la muestra consistió en adultos jóvenes de 18 a 45 años con NSCLBP.')">Adultos mayores de 65 años con artrosis.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'Los metadatos indican claramente que la muestra consistió en adultos jóvenes de 18 a 45 años con NSCLBP.')">Atletas de élite con dolor agudo.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'Los metadatos indican claramente que la muestra consistió en adultos jóvenes de 18 a 45 años con NSCLBP.')">Población pediátrica con escoliosis.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, true, 'Los metadatos indican claramente que la muestra consistió en adultos jóvenes de 18 a 45 años con NSCLBP.')">Adultos jóvenes (18-45 años) con dolor lumbar crónico inespecífico.</button>
                        
                    </div>
                    <div class="explanation"></div>
                </div><div class="quiz-item">
                    <p class="font-bold mb-2">4. ¿Dónde se aplicó el manguito neumático para la restricción del flujo sanguíneo?</p>
                    <div class="quiz-options">
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, true, 'La metodología detalla que el BFR se aplicó mediante manguito neumático en el muslo proximal izquierdo.')">Muslo proximal izquierdo.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'La metodología detalla que el BFR se aplicó mediante manguito neumático en el muslo proximal izquierdo.')">Brazo derecho.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'La metodología detalla que el BFR se aplicó mediante manguito neumático en el muslo proximal izquierdo.')">Ambos tobillos.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'La metodología detalla que el BFR se aplicó mediante manguito neumático en el muslo proximal izquierdo.')">Directamente sobre la zona lumbar.</button>
                        
                    </div>
                    <div class="explanation"></div>
                </div><div class="quiz-item">
                    <p class="font-bold mb-2">5. ¿Qué estrategia utiliza el estudio para inducir adaptaciones musculares sin elevar el estrés mecánico articular?</p>
                    <div class="quiz-options">
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'El fundamento del estudio es el uso de BFR (restricción de flujo sanguíneo) que permite adaptaciones con cargas bajas.')">Alta carga mecánica (&gt;80% RM).</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, true, 'El fundamento del estudio es el uso de BFR (restricción de flujo sanguíneo) que permite adaptaciones con cargas bajas.')">Baja carga con restricción de flujo (BFR).</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'El fundamento del estudio es el uso de BFR (restricción de flujo sanguíneo) que permite adaptaciones con cargas bajas.')">Electroestimulación muscular.</button>
                        
                            <button class="quiz-btn" onclick="checkAnswer(this, false, 'El fundamento del estudio es el uso de BFR (restricción de flujo sanguíneo) que permite adaptaciones con cargas bajas.')">Ejercicio aeróbico intenso.</button>
                        
                    </div>
                    <div class="explanation"></div>
                </div></div>
            </div>

            <!-- Footer / Export -->
            

        </article>

    </div>

    <script>
        // --- DATA & STATE ---
        const state = {
            metadata: {},
            scores: { design: 0, sample: 0, bias: 0, vars: 0, transfer: 0, coherence: 0 },
            justifications: {},
            textData: { results: '', critical: '', apps: {} },
            generatedQuiz: null
        };
        
        const DIMENSIONS = ['design', 'sample', 'bias', 'vars', 'transfer', 'coherence'];

        // --- INIT FOR PRELOADED DATA (EXPORTED FILES) ---
        window.addEventListener('DOMContentLoaded', () => {
            if (window.PRELOADED_STATE) {
                // Restore state
                Object.assign(state, window.PRELOADED_STATE);
                
                // Hide input sections
                const input = document.getElementById('input-section');
                if(input) input.classList.add('hidden');
                const conf = document.getElementById('confirmation-section');
                if(conf) conf.classList.add('hidden');
                
                // CRITICAL: Unhide dashboard BEFORE rendering charts
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('status-bar').innerText = "DASHBOARD ACTIVO (OFFLINE)";
                
                // Render everything
                renderDOM();
                renderQuiz();
            }
        });

        // --- DEMO DATA ---
        function loadDemoData() {
            document.getElementById('raw-text').value = `
EFFECTIVENESS OF PERCUTANEOUS ELECTROLYSIS IN PATELLAR TENDINOPATHY: A RANDOMIZED CONTROLLED TRIAL.
Authors: Garcia-Manzanares A, Smith J, Doe R.
Year: 2023
Journal: J Sports Sci Med
...
(Texto simulado para demostración de la herramienta)
            `;
            // Pre-fill hidden logic for demo
            document.getElementById('meta-title').value = "Eficacia de la Electrólisis Percutánea en Tendinopatía Rotuliana";
            document.getElementById('meta-authors').value = "Garcia-Manzanares A, et al.";
            document.getElementById('meta-year').value = "2023";
            document.getElementById('meta-journal').value = "J Sports Sci Med";
            document.getElementById('meta-design').value = "Ensayo Clínico Aleatorizado (RCT)";
            document.getElementById('meta-population').value = "n=60 Atletas semi-profesionales";
            document.getElementById('meta-intervention').value = "EPI (3 sesiones) + Ejercicio Excéntrico";
            
            // Set scores
            setScore('design', 4, "Aleatorización ciega simple, protocolo claro.");
            setScore('sample', 3, "n=60 es suficiente para potencia, pero monocéntrico.");
            setScore('bias', 4, "Evaluador ciego, análisis por intención de tratar.");
            setScore('vars', 5, "VISA-P validado y Ecografía Doppler.");
            setScore('transfer', 5, "Protocolo replicable en clínica privada.");
            setScore('coherence', 4, "Alineado con marco de mecanotransducción.");

            // Text
            document.getElementById('txt-results').value = "• Reducción del dolor (VAS) significativa a las 4 semanas.\n• Mejora en VISA-P superior al grupo control.\n• Cambios estructurales visibles en Doppler.";
            document.getElementById('txt-critical').value = "El diseño del estudio presenta una robustez metodológica notable para el ámbito de la fisioterapia invasiva. Se observa un control adecuado de variables confusoras mediante la estandarización de la carga de ejercicio en ambos grupos. Sin embargo, la falta de seguimiento a largo plazo (6 meses) limita la extrapolación sobre la recurrencia.\n\nEl estudio aporta evidencia moderada para la aplicación de Electrólisis Percutánea en Tendinopatía Rotuliana, con implicaciones clínicas relevantes.";
            
            document.getElementById('app-electro').value = "Dosis: 3mA, 3s, 3 impactos. Frecuencia semanal.";
            document.getElementById('app-exercise').value = "Vital combinar con protocolo excéntrico (3x15 repeticiones).";

            processText(true);
        }

        function setScore(key, val, just) {
            document.getElementById(`score-${key}`).value = val;
            document.getElementById(`just-${key}`).value = just;
            updateSlider(key);
        }

        // --- LOGIC ---

        async function processText(isDemo = false) {
            const raw = document.getElementById('raw-text').value;
            if (raw.trim().length < 10) { alert("Por favor, pegue un texto válido."); return; }

            const statusBar = document.getElementById('status-bar');
            const btn = document.querySelector('#input-section .btn:last-child'); // The analyze button

            if (!isDemo) {
                // Check if API is ready
                if (!window.analyzeTextWithGemini) {
                    alert("El sistema de análisis aún está cargando. Espere unos segundos e intente de nuevo.");
                    return;
                }

                // UI Loading State
                statusBar.innerText = "ANALIZANDO CON IA... POR FAVOR ESPERE";
                statusBar.classList.add('text-accent');
                btn.disabled = true;
                btn.innerText = "Analizando...";
                document.body.style.cursor = "wait";

                try {
                    console.log("Iniciando análisis...");
                    const data = await window.analyzeTextWithGemini(raw);
                    console.log("Datos recibidos:", data);
                    
                    if (!data) throw new Error("No data received");

                    // Populate Metadata
                    if(data.metadata) {
                        document.getElementById('meta-title').value = data.metadata.title || "";
                        document.getElementById('meta-authors').value = data.metadata.authors || "";
                        document.getElementById('meta-year').value = data.metadata.year || "";
                        document.getElementById('meta-journal').value = data.metadata.journal || "";
                        document.getElementById('meta-design').value = data.metadata.design || "";
                        document.getElementById('meta-population').value = data.metadata.population || "";
                        document.getElementById('meta-intervention').value = data.metadata.intervention || "";
                    }

                    // Populate Scores & Justifications
                    if(data.scores && data.justifications) {
                        DIMENSIONS.forEach(k => {
                            setScore(k, data.scores[k] || 0, data.justifications[k] || "");
                        });
                    }

                    // Populate Content
                    if(data.content) {
                        if (data.content.results && Array.isArray(data.content.results)) {
                            document.getElementById('txt-results').value = data.content.results.map(r => `• ${r}`).join('\n');
                        }
                        
                        document.getElementById('txt-critical').value = data.content.criticalAnalysis || "";

                        if (data.content.applicability) {
                            document.getElementById('app-electro').value = data.content.applicability.electro || "";
                            document.getElementById('app-neuro').value = data.content.applicability.neuro || "";
                            document.getElementById('app-dry').value = data.content.applicability.dry || "";
                            document.getElementById('app-exercise').value = data.content.applicability.exercise || "";
                        }
                    }

                    // Store Quiz Data
                    if(data.quiz) {
                        state.generatedQuiz = data.quiz;
                    }

                } catch (e) {
                    console.error("Error en processText:", e);
                    alert("Hubo un error al procesar el texto con la IA. Verifique la consola o intente nuevamente.");
                    return; // Do not proceed to next step on error
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Analizar Texto";
                    document.body.style.cursor = "default";
                    statusBar.classList.remove('text-accent');
                }
            }

            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('confirmation-section').classList.remove('hidden');
            document.getElementById('status-bar').innerText = "CONFIRMACIÓN DE METADATOS REQUERIDA";
            window.scrollTo(0,0);
        }

        function backToInput() {
            document.getElementById('confirmation-section').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
        }

        function updateSlider(id) {
            const val = document.getElementById(`score-${id}`).value;
            document.getElementById(`val-${id}`).innerText = val;
            state.scores[id] = parseInt(val);
        }

        function generateDashboard() {
            // 1. Capture Data
            state.metadata = {
                title: document.getElementById('meta-title').value || "Título no confirmado",
                authors: document.getElementById('meta-authors').value || "Autores n/a",
                year: document.getElementById('meta-year').value || "s.f.",
                journal: document.getElementById('meta-journal').value || "Fuente desconocida",
                design: document.getElementById('meta-design').value || "Diseño no especificado",
                pop: document.getElementById('meta-population').value || "No reportado",
                int: document.getElementById('meta-intervention').value || "Intervención desconocida"
            };

            // Capture Justifications
            DIMENSIONS.forEach(k => {
                state.justifications[k] = document.getElementById(`just-${k}`).value || "Sin justificación";
            });

            // Capture Text
            state.textData.results = document.getElementById('txt-results').value;
            state.textData.critical = document.getElementById('txt-critical').value;
            state.textData.apps = {
                electro: document.getElementById('app-electro').value,
                neuro: document.getElementById('app-neuro').value,
                dry: document.getElementById('app-dry').value,
                ex: document.getElementById('app-exercise').value
            };

            // Validation Check
            if(state.metadata.title.includes("confirmado")) {
                if(!confirm("Hay campos críticos vacíos. ¿Generar de todos modos?")) return;
            }

            // 2. Render Dashboard DOM
            renderDOM();

            // CRITICAL FIX: Unhide dashboard BEFORE rendering chart to ensure Canvas size is non-zero
            document.getElementById('confirmation-section').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('status-bar').innerText = "DASHBOARD ACTIVO";
            window.scrollTo(0,0);

            // 3. Render Chart (Safe) - removed as per request
            // renderChart();

            // 4. Generate Quiz
            renderQuiz();
        }

        function renderDOM() {
            // Header
            document.getElementById('dash-title').innerText = state.metadata.title;
            document.getElementById('dash-design').innerText = state.metadata.design;
            document.getElementById('dash-authors').innerText = state.metadata.authors;
            document.getElementById('dash-year').innerText = state.metadata.year;
            document.getElementById('dash-journal').innerText = state.metadata.journal;
            
            const totalScore = Object.values(state.scores).reduce((a,b)=>a+b,0);
            document.getElementById('dash-total-score').innerText = totalScore;
            
            // Meta Table
            document.getElementById('dash-pop').innerText = state.metadata.pop;
            document.getElementById('dash-int').innerText = state.metadata.int;
            
            // Results List
            const resList = document.getElementById('dash-results-list');
            resList.innerHTML = '';
            state.textData.results.split('\n').forEach(line => {
                if(line.trim().length > 2) {
                    const li = document.createElement('li');
                    li.innerText = line.replace(/^[•\-\*]\s?/, '');
                    resList.appendChild(li);
                }
            });

            // Critical Text (Format formatting)
            let critHTML = state.textData.critical.replace(/\n/g, '<br>');
            // Highlight specific final sentence
            critHTML = critHTML.replace(/El estudio aporta evidencia.*/i, (match) => `<div class="mt-4 p-4 border rounded bg-opacity-10 bg-yellow-500 font-bold text-accent border-l-4">${match}</div>`);
            document.getElementById('dash-critical-text').innerHTML = critHTML;

            // Rubric Table
            const tbody = document.getElementById('rubric-body');
            tbody.innerHTML = '';
            const labels = {
                design: "Diseño", sample: "Muestra", bias: "Control de Sesgos", 
                vars: "Variables", transfer: "Transferencia Clínica", coherence: "Coherencia"
            };
            // Use fixed order
            DIMENSIONS.forEach(key => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-bold">${labels[key]}</td>
                    <td><span class="score-badge">${state.scores[key]}/5</span></td>
                    <td class="text-secondary">${state.justifications[key]}</td>
                `;
                tbody.appendChild(tr);
            });

            // Clinical Applicability
            const appList = document.getElementById('dash-clinical-list');
            appList.innerHTML = '';
            const appMap = {
                electro: "Electrólisis Percutánea",
                neuro: "Neuromodulación",
                dry: "Punción Seca",
                ex: "Ejercicio / BFR"
            };
            Object.keys(state.textData.apps).forEach(k => {
                if(state.textData.apps[k]) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-white font-bold">${appMap[k]}:</span> <span class="text-secondary">${state.textData.apps[k]}</span>`;
                    appList.appendChild(li);
                }
            });
            if(appList.innerHTML === '') appList.innerHTML = '<li class="text-secondary italic">No se reportaron aplicaciones específicas para técnicas invasivas.</li>';
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            
            const questions = state.generatedQuiz || [
                {
                    q: "¿Cuál es la principal limitación metodológica señalada en este estudio?",
                    options: ["Falta de grupo control", "Tamaño muestral insuficiente", "Falta de seguimiento a largo plazo", "Instrumentos no validados"],
                    correct: 2, 
                    why: "La falta de follow-up > 6 meses impide conocer la tasa de recurrencia de la lesión."
                },
                // ... fallback ...
            ];

            questions.forEach((item, idx) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'quiz-item';
                qDiv.innerHTML = `
                    <p class="font-bold mb-2">${idx + 1}. ${item.q}</p>
                    <div class="quiz-options">
                        ${item.options.map((opt, i) => `
                            <button class="quiz-btn" onclick="checkAnswer(this, ${i === item.correct}, '${item.why.replace(/'/g, "\\'")}')">${opt}</button>
                        `).join('')}
                    </div>
                    <div class="explanation"></div>
                `;
                container.appendChild(qDiv);
            });
        }

        function checkAnswer(btn, isCorrect, reason) {
            const parent = btn.parentElement;
            const explanation = parent.nextElementSibling;
            
            Array.from(parent.children).forEach(b => b.disabled = true);
            
            if (isCorrect) {
                btn.classList.add('correct');
                explanation.innerHTML = `<span class="text-success font-bold">¡Correcto!</span> ${reason}`;
            } else {
                btn.classList.add('wrong');
                explanation.innerHTML = `<span class="text-danger font-bold">Incorrecto.</span> ${reason}`;
            }
            explanation.style.display = 'block';
        }

        function getFinalHTML() {
            // Clone document
            const exportDoc = document.documentElement.cloneNode(true);
            
            // Remove Input and Confirmation Sections
            const inputSec = exportDoc.querySelector('#input-section');
            const confSec = exportDoc.querySelector('#confirmation-section');
            if(inputSec) inputSec.remove();
            if(confSec) confSec.remove();

            // Ensure Dashboard is visible
            const dashSec = exportDoc.querySelector('#dashboard-view');
            if (dashSec) dashSec.classList.remove('hidden');

            // Remove buttons
            const noPrint = exportDoc.querySelectorAll('.no-print');
            noPrint.forEach(el => el.remove());

            // Clean up scripts for standalone offline file
            // 1. Remove the module script loading index.tsx (it won't exist offline)
            const moduleScripts = exportDoc.querySelectorAll('script[type="module"]');
            moduleScripts.forEach(s => {
                if(s.src.includes('index.tsx')) s.remove();
            });
            
            // 2. Remove importmap (not needed offline since logic is pre-calculated)
            const importMap = exportDoc.querySelector('script[type="importmap"]');
            if(importMap) importMap.remove();

            // Inject State script
            const body = exportDoc.querySelector('body');
            const scriptState = document.createElement('script');
            scriptState.textContent = `window.PRELOADED_STATE = ${JSON.stringify(state)};`;
            body.appendChild(scriptState);

            return "<!DOCTYPE html>\n" + exportDoc.outerHTML;
        }

        function downloadHTML() {
            const htmlContent = getFinalHTML();
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `El_FisioLogico_Dashboard_${state.metadata.year || 'Analisis'}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        async function copyHTML() {
            const htmlContent = getFinalHTML();
            try {
                await navigator.clipboard.writeText(htmlContent);
                alert("¡Código HTML copiado al portapapeles! Puede pegarlo en un archivo .html nuevo.");
            } catch (err) {
                // Fallback for non-secure contexts
                const textArea = document.createElement("textarea");
                textArea.value = htmlContent;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("¡Código HTML copiado al portapapeles! (Fallback)");
                } catch (err2) {
                    alert("No se pudo copiar automáticamente. Use la opción de Descargar.");
                }
                document.body.removeChild(textArea);
            }
        }

    </script>
    


        <script type="module" onerror="console.warn('Failed to load the app. Try reloading it.')">import '@/index';</script>
        <script>window.PRELOADED_STATE = {"metadata":{"title":"Effect of blood flow restriction training with core stabilization exercise on muscle activity and muscle thickness in subjects with nonspecific chronic low back pain","authors":"Phurichaya Werasirirat, Juntip Namsawang, Nutsupa Singhasoot, Nongnuch Luangpon, Audrius Snieckus, Pornpimol Muanjai","year":"2026","journal":"Journal of Back and Musculoskeletal Rehabilitation","design":"Ensayo clínico aleatorizado, paralelo, simple ciego","pop":"Adultos jóvenes (18–45 años) con dolor lumbar crónico inespecífico","int":"Ejercicio de estabilización del core combinado con entrenamiento con restricción de flujo sanguíneo (BFR+CSE)"},"scores":{"design":4,"sample":3,"bias":3,"vars":4,"transfer":3,"coherence":4},"justifications":{"design":"Ensayo clínico aleatorizado, diseño paralelo, protocolo registrado y cegamiento simple (participantes).","sample":"Tamaño muestral calculado por potencia (n=38), pero la población es joven y muy homogénea, limitando la validez externa.","bias":"Aleatorización por bloques adecuada, pero ausencia de grupo placebo y falta de doble ciego (terapeutas no cegados).","vars":"Uso de herramientas válidas y fiables: EMG normalizada, ecografía en modo B y cuestionario MODQ validado.","transfer":"Intervención de 4 semanas clínicamente aplicable y segura, pero la falta de seguimiento a medio plazo limita la certeza sobre la duración del efecto.","coherence":"Los hallazgos sobre activación muscular y BFR son consistentes con la literatura previa en rehabilitación y fisiología."},"textData":{"results":"• El grupo BFR+CSE mostró mejoras significativas intra-grupo en la actividad EMG normalizada de transverso del abdomen, multífidos y glúteo mayor.\n• Se observó un aumento significativo del grosor muscular tanto en reposo como en contracción en el grupo BFR+CSE.\n• El grupo BFR+CSE experimentó una reducción significativa de la discapacidad medida con el MODQ.\n• El grupo de solo ejercicio (CSE) presentó mejoras limitadas, restringidas principalmente a la EMG del multífido y grosor en reposo.\n• Las comparaciones entre grupos favorecieron consistentemente al grupo BFR+CSE frente al CSE aislado en todas las variables evaluadas.","critical":"El diseño del estudio, un ensayo clínico aleatorizado simple ciego, es adecuado para evaluar efectos de intervención, aunque el cegamiento se limita a los participantes, no a los terapeutas. El cálculo muestral está justificado y el tamaño final (n=38) cumple con la potencia estadística prevista, si bien sigue siendo modesto y vulnerable a variabilidad interindividual. La muestra se caracteriza por adultos jóvenes con bajo índice de masa corporal y discapacidad moderada, lo que define un perfil clínico concreto y relativamente homogéneo. Esto mejora la validez interna pero reduce la transferencia a poblaciones con mayor edad, comorbilidades o dolor lumbar más complejo. El control de sesgos es aceptable en cuanto a aleatorización y estandarización de la intervención, aunque la ausencia de grupo placebo o control sin manguito limita la atribución específica de los efectos al BFR. Las variables seleccionadas son pertinentes desde el punto de vista fisioterapéutico: EMG normalizada, grosor muscular ecográfico y discapacidad funcional. Las técnicas de medición están bien descritas y presentan buena fiabilidad intraexaminador. No obstante, la interpretación de aumentos en EMG como fuerza debe hacerse con cautela, ya que se trata de una medida indirecta de activación neuromuscular. La transferencia clínica es moderada: el protocolo es relativamente corto, de baja carga y potencialmente aplicable en contextos de rehabilitación donde la carga mecánica está limitada. Sin embargo, la falta de seguimiento impide conocer la persistencia de los efectos. La coherencia con la literatura es adecuada y los autores discuten los hallazgos en línea con estudios previos sobre BFR y adaptaciones neuromusculares. El estudio aporta evidencia moderada para la aplicación de BFR combinado con ejercicio de estabilización del core en dolor lumbar crónico inespecífico, con implicaciones clínicas relevantes.","apps":{"electro":"El estudio no evalúa intervenciones de electrólisis percutánea ni estimulación eléctrica invasiva, por lo que no se pueden inferir efectos combinados.","neuro":"Los cambios observados en la EMG sugieren una posible modulación central de la activación muscular, aunque el estudio no evalúa parámetros neurofisiológicos directos ni técnicas como tDCS.","dry":"No se aborda en el estudio; cualquier integración con punción seca sería especulativa al no existir datos en el texto.","ex":"El BFR aplicado distalmente combinado con ejercicio de estabilización del core (CSE) potencia la activación y grosor muscular proximal y reduce la discapacidad más que el CSE aislado. Es una opción útil para inducir adaptaciones neuromusculares cuando la carga mecánica está limitada."}},"generatedQuiz":[{"correct":1,"options":["El BFR no mostró diferencias respecto al ejercicio solo.","El BFR+CSE mejoró más la activación muscular y redujo la discapacidad que el CSE solo.","El CSE solo fue superior para la hipertrofia del glúteo mayor.","Ambos grupos empeoraron su discapacidad funcional."],"q":"¿Cuál fue el hallazgo principal al comparar el grupo BFR+CSE con el grupo de solo CSE?","why":"El estudio reporta que la comparación intergrupos favoreció consistentemente al grupo BFR+CSE en todas las variables (EMG, grosor y discapacidad)."},{"correct":2,"options":["Fuerza máxima isométrica directa.","Resonancia magnética funcional.","Grosor muscular mediante ecografía y actividad EMG.","Niveles de lactato en sangre."],"q":"¿Qué variables objetivas se utilizaron para medir los cambios estructurales y neuromusculares?","why":"La metodología especifica el uso de ecografía modo B para el grosor muscular y electromiografía (EMG) para la actividad muscular."},{"correct":3,"options":["Adultos mayores de 65 años con artrosis.","Atletas de élite con dolor agudo.","Población pediátrica con escoliosis.","Adultos jóvenes (18-45 años) con dolor lumbar crónico inespecífico."],"q":"¿Cuál es la población específica estudiada en este ensayo clínico?","why":"Los metadatos indican claramente que la muestra consistió en adultos jóvenes de 18 a 45 años con NSCLBP."},{"correct":0,"options":["Muslo proximal izquierdo.","Brazo derecho.","Ambos tobillos.","Directamente sobre la zona lumbar."],"q":"¿Dónde se aplicó el manguito neumático para la restricción del flujo sanguíneo?","why":"La metodología detalla que el BFR se aplicó mediante manguito neumático en el muslo proximal izquierdo."},{"correct":1,"options":["Alta carga mecánica (>80% RM).","Baja carga con restricción de flujo (BFR).","Electroestimulación muscular.","Ejercicio aeróbico intenso."],"q":"¿Qué estrategia utiliza el estudio para inducir adaptaciones musculares sin elevar el estrés mecánico articular?","why":"El fundamento del estudio es el uso de BFR (restricción de flujo sanguíneo) que permite adaptaciones con cargas bajas."}]};</script></body></html>
